#!/usr/bin/env sh

# Run lint-staged for formatting and linting
npx lint-staged

# Run type checking
echo "Running type check..."
npm run type-check

# Run related tests only for changed source/test files
echo "Running related tests for changed files..."
CHANGED_FILES=$(git diff --cached --name-only --diff-filter=ACMRTUXB | grep -E '\.(ts|tsx|js|jsx)$' || true)
if [ -n "$CHANGED_FILES" ]; then
  echo "$CHANGED_FILES" | xargs npx jest --runInBand --findRelatedTests --passWithNoTests || exit 1
else
  echo "No testable file changes detected; skipping related tests."
fi

# Check for console.log statements in staged files
echo "Checking for console.log statements..."
git diff --cached --name-only --diff-filter=ACM | grep -E '\.(ts|tsx|js|jsx)$' | xargs -r grep -l 'console.log' && {
  echo "Error: Found console.log statements in staged files"
  echo "Please remove console.log statements before committing"
  exit 1
} || true

echo "Pre-commit checks passed âœ…"